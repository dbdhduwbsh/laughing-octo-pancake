<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>å…¨èƒ½èŠå¤©</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --bg: #111827;
  --sidebar: #1f2937;
  --header: #1f2937;
  --border: #374151;
  --text: #e5e7eb;
  --text2: #9ca3af;
  --accent: #4f6eef;
  --msg-me: #4f6eef;
  --msg-other: #374151;
  --input: #374151;
  --hover: #4b5666;
  --scroll: #6b7280;
}

.theme-light {
  --bg: #fff;
  --sidebar: #f9fafb;
  --header: #f9fafb;
  --border: #e5e7eb;
  --text: #111827;
  --text2: #6b7280;
  --accent: #4f6eef;
  --msg-me: #4f6eef;
  --msg-other: #e5e7eb;
  --input: #f3f4f6;
  --hover: #e5e7eb;
  --scroll: #d1d5db;
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
}

#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* æ‰‹æœºé¡¶éƒ¨å¯¼èˆª */
.mobile-nav {
  display: flex;
  background: var(--header);
  border-bottom: 1px solid var(--border);
  padding: 12px 10px;
  gap: 6px;
  overflow-x: auto;
  scrollbar-width: none;
}
.mobile-nav::-webkit-scrollbar { display: none; }
.mobile-nav button {
  background: var(--input);
  border: none;
  color: var(--text);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  white-space: nowrap;
}
.mobile-nav button.active {
  background: var(--accent);
  color: #fff;
}

/* é¡µé¢å®¹å™¨ */
.pages {
  flex: 1;
  position: relative;
}
.page {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
}
.page.show {
  display: flex;
}

/* èŠå¤©å¤´éƒ¨ */
.chat-header {
  background: var(--header);
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.room-name {
  font-size: 16px;
  font-weight: 600;
}
.chat-header .btn {
  padding: 6px 10px;
  font-size: 13px;
}

/* å…¬å‘Š */
.announcement-bar {
  background: #1e293b;
  color: #f1f5f9;
  padding: 6px 16px;
  font-size: 13px;
  border-left: 4px solid #38bdf8;
}

/* èŠå¤©åŒºåŸŸ */
.chat-area {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
  background-size: cover;
  background-position: center;
}
.pinned-label {
  background: #f59e0b;
  color: #fff;
  font-size: 11px;
  padding: 1px 4px;
  border-radius: 3px;
  margin-bottom: 4px;
  display: inline-block;
}
.message {
  max-width: 80%;
  padding: 10px 12px;
  border-radius: 12px;
  position: relative;
  animation: fadeIn 0.2s;
  font-size: 15px;
  line-height: 1.4;
}
.message.mine {
  align-self: flex-end;
  background: var(--msg-me);
  color: white;
  border-bottom-right-radius: 4px;
}
.message.other {
  align-self: flex-start;
  background: var(--msg-other);
  border-bottom-left-radius: 4px;
}
.msg-name {
  font-size: 12px;
  color: var(--text2);
  margin-bottom: 3px;
}
.msg-at {
  color: #38bdf8;
  font-weight: 500;
}
.msg-actions {
  position: absolute;
  top: 4px;
  right: 4px;
  display: none;
  gap: 4px;
}
.message:hover .msg-actions {
  display: flex;
}
.msg-btn {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  background: #0003;
  color: #fff;
  border: none;
  font-size: 12px;
}

/* å¿«æ·å›å¤ */
.quick-reply {
  display: flex;
  gap: 6px;
  padding: 6px 12px;
  flex-wrap: wrap;
}
.quick-item {
  background: var(--input);
  padding: 5px 10px;
  border-radius: 8px;
  font-size: 13px;
  border: none;
  color: var(--text);
}

/* è¾“å…¥æ  */
.input-bar {
  background: var(--header);
  border-top: 1px solid var(--border);
  padding: 10px;
  display: flex;
  gap: 8px;
  align-items: flex-end;
}
#msgInput {
  flex: 1;
  min-height: 40px;
  max-height: 100px;
  border-radius: 10px;
  border: none;
  background: var(--input);
  color: var(--text);
  padding: 10px 12px;
  outline: none;
  font-size: 15px;
  resize: none;
}
.toolbar {
  display: flex;
  gap: 6px;
  margin-bottom: 5px;
}
.btn {
  height: 40px;
  padding: 0 12px;
  border-radius: 10px;
  background: var(--accent);
  color: white;
  border: none;
  font-size: 14px;
  white-space: nowrap;
}
.btn.secondary {
  background: var(--input);
  color: var(--text);
}

/* è¡¨æƒ…é¢æ¿ */
.emoji-panel {
  position: absolute;
  bottom: 130px;
  left: 10px;
  right: 10px;
  background: var(--sidebar);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 6px;
  max-height: 220px;
  overflow-y: auto;
  z-index: 99;
}
.emoji {
  padding: 6px;
  text-align: center;
  border-radius: 6px;
  font-size: 16px;
}
.emoji:hover {
  background: var(--hover);
}

/* å¼¹çª— */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
  padding: 20px;
}
.modal.show {
  display: flex;
}
.modal-box {
  background: var(--sidebar);
  border-radius: 12px;
  width: 100%;
  max-width: 380px;
  padding: 20px;
}
.modal-title {
  font-size: 17px;
  margin-bottom: 14px;
}
.input-group {
  margin-bottom: 12px;
}
.input-label {
  font-size: 14px;
  margin-bottom: 6px;
  display: block;
}
.input-control {
  width: 100%;
  height: 42px;
  border-radius: 10px;
  background: var(--input);
  color: var(--text);
  border: none;
  padding: 0 12px;
  outline: none;
}
.modal-btns {
  display: flex;
  gap: 10px;
  margin-top: 16px;
  justify-content: flex-end;
}

/* è§†é¢‘ & æ–‡ä»¶ */
.video-container, .files-list {
  flex: 1;
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  overflow-y: auto;
}
.video-box {
  background: #000;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}
video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.video-name {
  position: absolute;
  bottom: 6px;
  left: 6px;
  background: #0006;
  color: #fff;
  padding: 3px 6px;
  border-radius: 6px;
  font-size: 12px;
}
.file-item {
  background: var(--input);
  padding: 10px;
  border-radius: 10px;
}
.file-name {
  font-size: 14px;
  margin-bottom: 6px;
  white-space: nowrap;
  overflow: hidden;
  text-indent: 0;
}
.file-preview {
  max-width: 100%;
  max-height: 100px;
  border-radius: 6px;
  margin-bottom: 6px;
  object-fit: cover;
}
.down-btn {
  width: 100%;
  padding: 6px;
  border-radius: 6px;
  background: var(--accent);
  color: #fff;
  border: none;
}

/* è®¾ç½®é¡µ */
.settings {
  padding: 16px;
  overflow-y: auto;
}
.setting-item {
  margin-bottom: 16px;
}
.setting-label {
  font-size: 15px;
  margin-bottom: 8px;
  display: block;
}
.avatar-upload {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: var(--input);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  margin-bottom: 10px;
}
.avatar-upload img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

.file-input {
  display: none;
}
</style>
</head>
<body>

<div id="app">
  <!-- æ‰‹æœºé¡¶éƒ¨å¯¼èˆª -->
  <div class="mobile-nav">
    <button onclick="showPage('chat')" class="active" id="nav_chat">ğŸ’¬ èŠå¤©</button>
    <button onclick="showPage('call')" id="nav_call">ğŸ“ é€šè¯</button>
    <button onclick="showPage('files')" id="nav_files">ğŸ“ æ–‡ä»¶</button>
    <button onclick="showPage('settings')" id="nav_settings">âš™ è®¾ç½®</button>
    <button onclick="showPage('admin')" id="nav_admin" style="display:none;">ğŸ”§ ç®¡ç†</button>
  </div>

  <div class="pages">
    <!-- èŠå¤©é¡µ -->
    <div class="page show" id="chatPage">
      <div class="chat-header">
        <div class="room-name">å…¬å…±ç¾¤èŠ</div>
        <button class="btn secondary" onclick="showRoomModal()">æˆ¿é—´å¯†ç </button>
      </div>
      <div class="announcement-bar" id="announceBar">å…¬å‘Šï¼šæœªè®¾ç½®å…¬å‘Š</div>
      <div class="chat-area" id="chatArea"></div>
      <div class="quick-reply" id="quickWrap"></div>
      <div class="input-bar">
        <div class="toolbar">
          <button class="btn secondary" onclick="toggleEmoji()">ğŸ˜Š</button>
          <button class="btn secondary" onclick="openAtList()">@</button>
          <button class="btn secondary" onclick="openSchedule()">â°</button>
          <button class="btn secondary" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
          <button class="btn secondary" onclick="speakInput()">ğŸ”Š</button>
        </div>
        <textarea id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" rows="1"></textarea>
        <button class="btn" onclick="sendMsg()">å‘é€</button>
      </div>
      <div class="emoji-panel" id="emojiPanel" style="display: none;"></div>
    </div>

    <!-- é€šè¯é¡µ -->
    <div class="page" id="callPage">
      <div class="chat-header">
        <div class="room-name">è§†é¢‘é€šè¯</div>
      </div>
      <div class="video-container" id="videos"></div>
      <div style="padding:10px;display:flex;gap:10px;">
        <button class="btn" onclick="startCall(true)">å¼€å¯æ‘„åƒå¤´</button>
        <button class="btn" onclick="startScreenShare()">å±å¹•å…±äº«</button>
        <button class="btn secondary" onclick="hangup()">æŒ‚æ–­</button>
      </div>
    </div>

    <!-- æ–‡ä»¶é¡µ -->
    <div class="page" id="filesPage">
      <div class="chat-header">
        <div class="room-name">æ–‡ä»¶åº“</div>
      </div>
      <div class="files-list" id="filesList"></div>
    </div>

    <!-- è®¾ç½®é¡µ -->
    <div class="page" id="settingsPage">
      <div class="settings">
        <div class="setting-item">
          <label class="setting-label">å¤´åƒ</label>
          <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
            <img id="avatarPreview" src="">
          </div>
          <input type="file" id="avatarInput" accept="image/*" class="file-input">
        </div>
        <div class="setting-item">
          <label class="setting-label">ç”¨æˆ·å</label>
          <input class="input-control" id="setName">
        </div>
        <div class="setting-item">
          <label class="setting-label">ä¸»é¢˜</label>
          <select class="input-control" id="themeSelect">
            <option value="dark">æ·±è‰²</option>
            <option value="light">æµ…è‰²</option>
          </select>
        </div>
        <div class="setting-item">
          <label class="setting-label">èŠå¤©èƒŒæ™¯</label>
          <input type="file" id="bgInput" accept="image/*" class="file-input">
          <button class="btn secondary" style="margin-top:6px;" onclick="setChatBg()">è®¾ç½®èƒŒæ™¯</button>
        </div>
        <div class="setting-item">
          <label class="setting-label">æˆ¿é—´å¯†ç </label>
          <input class="input-control" id="roomPwd" placeholder="ç•™ç©ºåˆ™æ— å¯†ç ">
        </div>
        <div class="setting-item">
          <label class="setting-label">ç®¡ç†å‘˜å¯†ç </label>
          <input class="input-control" id="adminPwd" placeholder="è®¾ç½®åæˆä¸ºç®¡ç†å‘˜">
        </div>
        <button class="btn" style="margin-top:10px;width:100%;" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>

    <!-- ç®¡ç†é¡µ -->
    <div class="page" id="adminPage">
      <div class="settings">
        <div class="setting-item">
          <label class="setting-label">ç¾¤å…¬å‘Š</label>
          <input class="input-control" id="announceInput" placeholder="è¾“å…¥å…¬å‘Š">
          <button class="btn secondary" style="margin-top:6px;width:100%;" onclick="setAnnounce()">å‘å¸ƒå…¬å‘Š</button>
        </div>
        <div class="setting-item">
          <label class="setting-label">å¿«æ·å›å¤</label>
          <input class="input-control" id="quickInput" placeholder="ç”¨ | åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå¥½çš„|æ”¶åˆ°|è°¢è°¢">
          <button class="btn secondary" style="margin-top:6px;width:100%;" onclick="setQuick()">è®¾ç½®å¿«æ·çŸ­è¯­</button>
        </div>
        <div class="setting-item">
          <label class="setting-label">ç”¨æˆ·ç®¡ç†</label>
          <div id="userList" style="display:grid;gap:6px;margin-top:6px;"></div>
        </div>
        <button class="btn secondary" style="margin-top:10px;width:100%;" onclick="clearHistory()">æ¸…ç©ºæœ¬åœ°èŠå¤©è®°å½•</button>
      </div>
    </div>
  </div>
</div>

<!-- å¼¹çª— -->
<div class="modal" id="roomModal">
  <div class="modal-box">
    <div class="modal-title">æˆ¿é—´å¯†ç éªŒè¯</div>
    <div class="input-group">
      <input class="input-control" id="inputPwd" type="password" placeholder="è¾“å…¥å¯†ç ">
    </div>
    <div class="modal-btns">
      <button class="btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="checkRoomPwd()">è¿›å…¥</button>
    </div>
  </div>
</div>

<div class="modal" id="atModal">
  <div class="modal-box">
    <div class="modal-title">é€‰æ‹©è¦@çš„ç”¨æˆ·</div>
    <div id="atList" style="max-height:220px;overflow-y:auto;display:grid;gap:6px;margin-top:10px;"></div>
    <div class="modal-btns">
      <button class="btn" onclick="closeModal()">å®Œæˆ</button>
    </div>
  </div>
</div>

<div class="modal" id="scheduleModal">
  <div class="modal-box">
    <div class="modal-title">å®šæ—¶å‘é€</div>
    <div class="input-group">
      <input class="input-control" id="scheduleText" placeholder="æ¶ˆæ¯å†…å®¹">
    </div>
    <div class="input-group">
      <input class="input-control" id="scheduleSec" type="number" value="10" placeholder="ç§’æ•°">
    </div>
    <div class="modal-btns">
      <button class="btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="setSchedule()">ç¡®å®š</button>
    </div>
  </div>
</div>

<input type="file" id="fileInput" multiple class="file-input">

<script>
const userId = Math.random().toString(36).slice(2,10);
let myName = localStorage.getItem('userName') || 'ç”¨æˆ·'+userId.slice(-4);
let myAvatar = localStorage.getItem('userAvatar') || '';
let roomPassword = localStorage.getItem('roomPwd') || '';
let adminPassword = localStorage.getItem('adminPwd') || '';
let currentTheme = localStorage.getItem('theme') || 'dark';
let chatBg = localStorage.getItem('chatBg') || '';
let announcement = localStorage.getItem('announcement') || 'å…¬å‘Šï¼šæœªè®¾ç½®å…¬å‘Š';
let quickList = localStorage.getItem('quickList')?.split('|') || ['å¥½çš„','æ”¶åˆ°','è°¢è°¢','æ²¡é—®é¢˜'];
let isAdmin = !!adminPassword;

let messageList = JSON.parse(localStorage.getItem('chatHistory') || '[]');
let pinnedMsg = localStorage.getItem('pinnedMsg') || '';
let onlineUsers = {};
let mutedUsers = JSON.parse(localStorage.getItem('mutedUsers') || '[]');
let files = {};
let localStream = null;
let screenStream = null;
let pcMap = {};

const iceConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

let ws;
function initSignaling() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const host = window.location.host;
  ws = new WebSocket(protocol + '//' + host);
  ws.onopen = () => console.log('âœ… å·²è¿æ¥æœåŠ¡å™¨');
  ws.onmessage = (e) => {
    const d = JSON.parse(e.data);
    if (d.roomPwd && d.roomPwd !== roomPassword) return;
    if (d.type === 'user') onlineUsers[d.from] = { name:d.name, avatar:d.avatar };
    if (d.type === 'msg') handleMsg(d);
    if (d.type === 'recall') handleRecall(d);
    if (d.type === 'read') handleRead(d);
    if (d.type === 'file') handleFileInfo(d);
    if (d.type === 'mute') handleMute(d);
    if (d.type === 'announce') { announcement = d.content; localStorage.setItem('announcement',announcement); renderAnnounce(); }
    if (d.type === 'pin') { pinnedMsg = d.mid; localStorage.setItem('pinnedMsg',pinnedMsg); renderChat(); }
    if (d.type === 'offer') handleOffer(d);
    if (d.type === 'answer') handleAnswer(d);
    if (d.type === 'ice') handleIce(d);
  };
  setInterval(() => send({ type:'user' }), 2000);
}

function send(data) {
  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify({ ...data, from: userId, name: myName, avatar: myAvatar, roomPwd: roomPassword }));
  }
}

// æ‰‹æœºé¡µé¢åˆ‡æ¢
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
  document.getElementById(page+'Page').classList.add('show');
  document.querySelectorAll('.mobile-nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('nav_'+page).classList.add('active');
}

window.onload = () => {
  initTheme(); initUser(); initEmoji(); initSignaling(); bindEvents();
  loadChatBg(); renderAnnounce(); renderQuick(); renderChat();
  onlineUsers[userId] = { name:myName, avatar:myAvatar };
  if(isAdmin) document.getElementById('nav_admin').style.display = 'inline-block';
};

// ä»¥ä¸‹åŠŸèƒ½é€»è¾‘å…¨éƒ¨ä¿ç•™ï¼Œä¸å½±å“æ‰‹æœºé€‚é…
function initTheme(){
  document.documentElement.className = currentTheme === 'light' ? 'theme-light' : '';
  document.getElementById('themeSelect').value = currentTheme;
}
function switchTheme(v){ currentTheme = v; localStorage.setItem('theme',v); initTheme(); }
function initUser(){
  document.getElementById('avatarPreview').src = myAvatar;
  document.getElementById('setName').value = myName;
  document.getElementById('roomPwd').value = roomPassword;
  document.getElementById('adminPwd').value = adminPassword;
  document.getElementById('announceInput').value = announcement;
}
function uploadAvatar(e){ const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{myAvatar=r.result;localStorage.setItem('userAvatar',myAvatar);initUser();};r.readAsDataURL(f);}
function setChatBg(){ const f=document.getElementById('bgInput').files[0];if(!f)return;const r=new FileReader();r.onload=()=>{chatBg=r.result;localStorage.setItem('chatBg',chatBg);loadChatBg();};r.readAsDataURL(f);}
function loadChatBg(){ const a=document.getElementById('chatArea');if(chatBg)a.style.backgroundImage=`url(${chatBg})`;else a.style.backgroundImage='none';}
function setAnnounce(){ announcement=document.getElementById('announceInput').value||'å…¬å‘Šï¼šæœªè®¾ç½®å…¬å‘Š';localStorage.setItem('announcement',announcement);renderAnnounce();send({type:'announce',content:announcement});}
function renderAnnounce(){ document.getElementById('announceBar').innerText=announcement; }
function setQuick(){ const v=document.getElementById('quickInput').value.trim();if(!v)return;quickList=v.split('|');localStorage.setItem('quickList',quickList.join('|'));renderQuick();}
function renderQuick(){ const w=document.getElementById('quickWrap');w.innerHTML='';quickList.forEach(t=>{const d=document.createElement('button');d.className='quick-item';d.textContent=t;d.onclick=()=>{document.getElementById('msgInput').value=t;};w.appendChild(d);});}
const emojis=['ğŸ˜€','ğŸ˜','ğŸ˜‚','ğŸ¤£','ğŸ˜ƒ','ğŸ˜„','ğŸ˜…','ğŸ˜†','ğŸ˜‰','ğŸ˜Š','ğŸ˜‹','ğŸ˜','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ¥³','ğŸ˜œ','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤©','ğŸ¤”','ğŸ¤«','ğŸ˜´','ğŸ˜¤','ğŸ¤®','ğŸ¤¬','ğŸ˜³','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜µ','ğŸ˜‡','ğŸ˜ˆ','ğŸ‘»','ğŸ‘½','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’Œ','ğŸ’˜','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’š','ğŸ’™','ğŸ’›','ğŸ¤','ğŸ¤','ğŸ–¤','â¤ï¸','ğŸ’‹','ğŸ‘‹','ğŸ¤š','ğŸ–','âœ‹','ğŸ¤Œ','ğŸ¤','ğŸ‘','ğŸ‘','âœŒ','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘Œ','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ‘‡','â˜','ğŸ‘€','ğŸ‘¤','ğŸ‘¥','ğŸ‘¶','ğŸ‘§','ğŸ‘¦','ğŸ‘©','ğŸ‘¨','ğŸ‘µ','ğŸ‘´','ğŸ™‹','ğŸ™Œ','ğŸ™','ğŸ’ª','ğŸ¦µ','ğŸ¦¶','ğŸ‘‚','ğŸ‘ƒ','ğŸ§ ','ğŸ‘','ğŸ‘…','ğŸ‘„'];
function initEmoji(){ const p=document.getElementById('emojiPanel');emojis.forEach(e=>{const d=document.createElement('div');d.className='emoji';d.textContent=e;d.onclick=()=>insertEmoji(e);p.appendChild(d);});}
function toggleEmoji(){ const p=document.getElementById('emojiPanel');p.style.display=p.style.display==='none'?'grid':'none';}
function insertEmoji(e){ const i=document.getElementById('msgInput');i.value+=e;i.focus();}
function speakInput(){ const t=document.getElementById('msgInput').value.trim();if(!t)return;const u=new SpeechSynthesisUtterance();u.text=t;speechSynthesis.speak(u);}
function closeModal(){ document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show')); }
function showRoomModal(){ document.getElementById('roomModal').classList.add('show'); }
function checkRoomPwd(){ const v=document.getElementById('inputPwd').value;if(v===roomPassword||!roomPassword)closeModal();else alert('å¯†ç é”™è¯¯');}
function openSchedule(){ document.getElementById('scheduleModal').classList.add('show'); }
function openAtList(){ const l=document.getElementById('atList');l.innerHTML='';for(const u in onlineUsers){const i=document.createElement('button');i.className='quick-item';i.textContent=onlineUsers[u].name;i.onclick=()=>{document.getElementById('msgInput').value+=`@${onlineUsers[u].name} `;};l.appendChild(i);}document.getElementById('atModal').classList.add('show');}
function setSchedule(){ const t=document.getElementById('scheduleText').value.trim();const s=parseInt(document.getElementById('scheduleSec').value)||10;if(!t)return;closeModal();setTimeout(()=>{const mid=Date.now()+'';addMessage({mid,from:userId,name:myName,content:t,mine:true,read:true});send({type:'msg',mid,content:t});},s*1000);alert('å·²è®¾ç½®');}
function sendMsg(){ if(mutedUsers.includes(userId))return alert('ä½ å·²è¢«ç¦è¨€');const t=document.getElementById('msgInput').value.trim();if(!t)return;const mid=Date.now()+'';addMessage({mid,from:userId,name:myName,content:t,mine:true,read:true});send({type:'msg',mid,content:t});document.getElementById('msgInput').value='';document.getElementById('emojiPanel').style.display='none';}
function addMessage(m){ messageList.push(m);if(messageList.length>300)messageList.shift();localStorage.setItem('chatHistory',JSON.stringify(messageList));renderChat();}
function renderChat(){ const a=document.getElementById('chatArea');a.innerHTML='';if(pinnedMsg){const p=messageList.find(x=>x.mid===pinnedMsg);if(p){const d=document.createElement('div');d.className='message '+(p.mine?'mine':'other');d.innerHTML=`<div class="pinned-label">ç½®é¡¶</div><div class="msg-content">${p.content.replace(/@([^\s]+)/g,'<span class="msg-at">@$1</span>')}</div>`;a.appendChild(d);}}messageList.forEach(m=>{const d=document.createElement('div');d.className='message '+(m.mine?'mine':'other');d.dataset.mid=m.mid;if(!m.mine){const n=document.createElement('div');n.className='msg-name';n.textContent=m.name;d.appendChild(n);}const c=document.createElement('div');c.className='msg-content';c.innerHTML=m.content.replace(/@([^\s]+)/g,'<span class="msg-at">@$1</span>');d.appendChild(c);const ac=document.createElement('div');ac.className='msg-actions';if(m.mine||isAdmin){const b1=document.createElement('button');b1.className='msg-btn';b1.textContent='Ã—';b1.onclick=()=>recallMessage(m.mid);ac.appendChild(b1);if(isAdmin){const b2=document.createElement('button');b2.className='msg-btn';b2.textContent='é¡¶';b2.onclick=()=>pinMessage(m.mid);ac.appendChild(b2);}}d.appendChild(ac);a.appendChild(d);});a.scrollTop=1e9;}
function pinMessage(m){ pinnedMsg=m;localStorage.setItem('pinnedMsg',m);send({type:'pin',mid:m});renderChat();}
function handleMsg(d){ if(mutedUsers.includes(d.from))return;addMessage({mid:d.mid,from:d.from,name:d.name,content:d.content,mine:false,read:false});send({type:'read',mid:d.mid});}
function recallMessage(m){ send({type:'recall',mid:m});messageList=messageList.filter(x=>x.mid!==m);localStorage.setItem('chatHistory',JSON.stringify(messageList));renderChat();}
function handleRecall(d){ messageList=messageList.filter(x=>x.mid!==d.mid);localStorage.setItem('chatHistory',JSON.stringify(messageList));renderChat();}
function handleRead(d){ messageList.forEach(m=>{if(m.mid===d.mid)m.read=true});renderChat();}
function sendFiles(e){ if(mutedUsers.includes(userId))return alert('ç¦è¨€ä¸­');Array.from(e.target.files).forEach(f=>{const r=new FileReader();const id=Date.now()+'';r.onload=()=>{files[id]={name:f.name,type:f.type,data:r.result,progress:100};send({type:'file',fid:id,fname:f.name,ftype:f.type});refreshFiles();};r.readAsDataURL(f);});}
function handleFileInfo(d){ files[d.fid]={name:d.fname,type:d.ftype,data:'',progress:0};refreshFiles();setTimeout(()=>{files[d.fid].progress=100;refreshFiles();},600);}
function refreshFiles(){ const l=document.getElementById('filesList');l.innerHTML='';for(const f in files){const i=document.createElement('div');i.className='file-item';const d=files[f];if(d.type.startsWith('image/')&&d.data){const img=document.createElement('img');img.className='file-preview';img.src=d.data;i.appendChild(img);}const n=document.createElement('div');n.className='file-name';n.textContent=d.name;i.appendChild(n);const p=document.createElement('div');p.style.height='3px';p.style.background='var(--accent)';p.style.width=d.progress+'%';p.style.borderRadius='2px';i.appendChild(p);const b=document.createElement('button');b.className='down-btn';b.textContent=d.progress>=100?'ä¸‹è½½':'æ¥æ”¶ä¸­';b.disabled=d.progress<100;b.onclick=()=>{const a=document.createElement('a');a.href=d.data;a.download=d.name;a.click();};i.appendChild(b);l.appendChild(i);}}
async function startCall(v){ localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:v});addVideo(userId,myName,localStream);broadcastCall();}
async function startScreenShare(){ screenStream=await navigator.mediaDevices.getDisplayMedia({audio:true,video:true});addVideo(userId,myName+'å±',screenStream);broadcastCall();}
function addVideo(u,n,s){ const b=document.createElement('div');b.className='video-box';const v=document.createElement('video');v.autoplay=true;v.playsInline=true;v.srcObject=s;const t=document.createElement('div');t.className='video-name';t.textContent=n;b.appendChild(v);b.appendChild(t);document.getElementById('videos').appendChild(b);}
function hangup(){ if(localStream)localStream.getTracks().forEach(t=>t.stop());if(screenStream)screenStream.getTracks().forEach(t=>t.stop());localStream=screenStream=null;pcMap={};document.getElementById('videos').innerHTML='';}
async function broadcastCall(){ for(const u in onlineUsers)if(u!==userId)await makeOffer(u);}
async function makeOffer(p){ const c=new RTCPeerConnection(iceConfig);pcMap[p]=c;if(localStream)localStream.getTracks().forEach(t=>c.addTrack(t,localStream));if(screenStream)screenStream.getTracks().forEach(t=>c.addTrack(t,screenStream));c.onicecandidate=e=>e.candidate&&send({type:'ice',to:p,data:e.candidate});c.ontrack=e=>addVideo(p,onlineUsers[p]?.name||p,e.streams[0]);const o=await c.createOffer();await c.setLocalDescription(o);send({type:'offer',to:p,data:o});}
async function handleOffer(d){ const c=new RTCPeerConnection(iceConfig);pcMap[d.from]=c;if(localStream)localStream.getTracks().forEach(t=>c.addTrack(t,localStream));if(screenStream)screenStream.getTracks().forEach(t=>c.addTrack(t,screenStream));c.onicecandidate=e=>e.candidate&&send({type:'ice',to:d.from,data:e.candidate});c.ontrack=e=>addVideo(d.from,d.name,e.streams[0]);await c.setRemoteDescription(d.data);const a=await c.createAnswer();await c.setLocalDescription(a);send({type:'answer',to:d.from,data:a});}
async function handleAnswer(d){ await pcMap[d.from].setRemoteDescription(d.data); }
async function handleIce(d){ await pcMap[d.from].addIceCandidate(new RTCIceCandidate(d.data)); }
function refreshAdminList(){ const l=document.getElementById('userList');l.innerHTML='';for(const u in onlineUsers){const i=document.createElement('button');i.className='quick-item';i.style.width='100%';i.textContent=onlineUsers[u].name;i.onclick=()=>toggleMute(u);l.appendChild(i);}}
function toggleMute(u){ mutedUsers.includes(u)?mutedUsers=mutedUsers.filter(x=>x!==u):mutedUsers.push(u);localStorage.setItem('mutedUsers',JSON.stringify(mutedUsers));send({type:'mute',list:mutedUsers});refreshAdminList();}
function handleMute(d){ if(!isAdmin)return;mutedUsers=d.list;localStorage.setItem('mutedUsers',JSON.stringify(mutedUsers));refreshAdminList();}
function clearHistory(){ messageList=[];localStorage.removeItem('chatHistory');renderChat();alert('å·²æ¸…ç©º');}
function saveSettings(){ myName=document.getElementById('setName').value.trim()||myName;roomPassword=document.getElementById('roomPwd').value;adminPassword=document.getElementById('adminPwd').value;isAdmin=!!adminPassword;localStorage.setItem('userName',myName);localStorage.setItem('roomPwd',roomPassword);localStorage.setItem('adminPwd',adminPassword);switchTheme(document.getElementById('themeSelect').value);initUser();document.getElementById('nav_admin').style.display=isAdmin?'inline-block':'none';alert('ä¿å­˜æˆåŠŸ');}
function bindEvents(){ document.getElementById('msgInput').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendMsg();}});document.getElementById('avatarInput').addEventListener('change',uploadAvatar);document.getElementById('fileInput').addEventListener('change',sendFiles);}
</script>
</body>
</html>
