<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨èƒ½èŠå¤©Â·å±€åŸŸç½‘åä½œå¹³å°</title>
<style>
:root {
  --bg: #111827;
  --sidebar: #1f2937;
  --header: #1f2937;
  --border: #374151;
  --text: #e5e7eb;
  --text2: #9ca3af;
  --accent: #4f6eef;
  --msg-me: #4f6eef;
  --msg-other: #374151;
  --input: #374151;
  --hover: #4b5666;
  --scroll: #6b7280;
}
.theme-light {
  --bg: #fff;
  --sidebar: #f9fafb;
  --header: #f9fafb;
  --border: #e5e7eb;
  --text: #111827;
  --text2: #6b7280;
  --accent: #4f6eef;
  --msg-me: #4f6eef;
  --msg-other: #e5e7eb;
  --input: #f3f4f6;
  --hover: #e5e7eb;
  --scroll: #d1d5db;
}
* {
  margin: 0; padding: 0; box-sizing: border-box;
  font-family: system-ui, -apple-system, sans-serif;
}
html, body { height: 100%; background: var(--bg); color: var(--text); }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: var(--scroll); border-radius: 3px; }

#app {
  display: grid;
  grid-template-columns: 240px 1fr;
  grid-template-rows: 60px 1fr;
  height: 100vh;
  overflow: hidden;
}

.sidebar {
  background: var(--sidebar);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); }
.sidebar-title { font-size: 18px; font-weight: 600; }
.user-info { margin-top: 8px; font-size: 14px; color: var(--text2); display: flex; align-items: center; gap: 8px; }
.avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: var(--accent); }

.nav { flex: 1; overflow-y: auto; padding: 8px; }
.nav-item { padding: 10px 12px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; }
.nav-item:hover { background: var(--hover); }
.nav-item.active { background: var(--accent); color: #fff; }

.main { display: flex; flex-direction: column; overflow: hidden; }
.header {
  background: var(--header);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 16px; justify-content: space-between; height: 60px;
}
.room-name { font-size: 16px; font-weight: 500; }

.announcement-bar {
  background: #1e293b; color: #f1f5f9;
  padding: 6px 16px; font-size: 13px;
  border-left: 3px solid #38bdf8;
}

.chat-area {
  flex: 1; overflow-y: auto; padding: 16px;
  display: flex; flex-direction: column; gap: 12px;
  background-size: cover; background-position: center;
}
.pinned-label {
  background: #f59e0b; color: #fff;
  font-size: 11px; padding: 1px 4px; border-radius: 3px;
  margin-bottom: 4px; display: inline-block;
}
.message {
  max-width: 75%; padding: 10px 14px; border-radius: 12px;
  position: relative; animation: fadeIn 0.2s;
}
.message.mine { align-self: flex-end; background: var(--msg-me); color: white; }
.message.other { align-self: flex-start; background: var(--msg-other); }
.msg-name { font-size: 12px; margin-bottom: 4px; color: var(--text2); }
.msg-content { line-height: 1.4; }
.msg-at { color: #38bdf8; font-weight: 500; }
.msg-read { position: absolute; right: 8px; bottom: 4px; font-size: 11px; color: var(--text2); }
.msg-actions { position: absolute; top: 4px; right: 4px; display: none; gap: 4px; }
.message:hover .msg-actions { display: flex; }
.msg-btn {
  width: 20px; height: 20px; border-radius: 4px;
  background: var(--bg); color: var(--text);
  border: none; cursor: pointer; font-size: 12px;
}

.input-bar {
  background: var(--header);
  border-top: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 8px 12px; gap: 6px;
}
#msgInput {
  flex: 1; height: 40px; border-radius: 8px;
  border: none; background: var(--input); color: var(--text);
  padding: 0 12px; outline: none;
}
.toolbar { display: flex; gap: 6px; flex-wrap: wrap; }
.btn {
  height: 40px; padding: 0 14px; border: none;
  border-radius: 8px; background: var(--accent); color: white; cursor: pointer;
}
.btn.secondary { background: var(--input); }

.emoji-panel {
  position: absolute; bottom: 80px;
  background: var(--sidebar); border: 1px solid var(--border);
  border-radius: 8px; padding: 8px;
  display: grid; grid-template-columns: repeat(8, 1fr);
  gap: 4px; max-width: 260px; z-index: 99;
}
.emoji { padding: 4px; border-radius: 4px; cursor: pointer; text-align: center; }
.emoji:hover { background: var(--hover); }

.file-progress { height: 3px; background: var(--accent); border-radius: 2px; margin-top: 6px; transition: width 0.2s; }

.modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  display: none; align-items: center; justify-content: center; z-index: 999;
}
.modal.show { display: flex; }
.modal-box {
  background: var(--sidebar); border-radius: 12px;
  width: 90%; max-width: 460px; padding: 20px;
}
.modal-title { font-size: 18px; margin-bottom: 16px; }
.modal-btns { display: flex; gap: 10px; margin-top: 20px; }
.input-group { margin-bottom: 14px; }
.input-label { display: block; margin-bottom: 6px; font-size: 14px; color: var(--text2); }
.input-control {
  width: 100%; height: 40px; padding: 0 10px;
  border-radius: 6px; background: var(--input);
  border: none; color: var(--text); outline: none;
}

.video-container {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 10px; padding: 10px; flex: 1;
}
.video-box { background: #000; border-radius: 8px; overflow: hidden; position: relative; }
video { width: 100%; height: 100%; object-fit: cover; }
.video-name {
  position: absolute; bottom: 8px; left: 8px;
  background: rgba(0,0,0,0.5); padding: 4px 8px;
  border-radius: 4px; font-size: 12px; color: white;
}

.files-list {
  padding: 10px; display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 10px; flex: 1; overflow-y: auto;
}
.file-item { background: var(--input); padding: 10px; border-radius: 8px; }
.file-name { font-size: 14px; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-preview { max-width: 100%; max-height: 120px; border-radius: 6px; margin-bottom: 6px; object-fit: cover; }
.down-btn { width: 100%; padding: 6px; border-radius: 6px; background: var(--accent); color: white; border: none; cursor: pointer; }

.tab-bar { display: flex; gap: 8px; padding: 8px; background: var(--header); border-bottom: 1px solid var(--border); }
.tab { padding: 8px 12px; border-radius: 6px; cursor: pointer; }
.tab.active { background: var(--accent); color: white; }
.page { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.page.show { display: flex; }

.settings { padding: 16px; }
.setting-item { margin-bottom: 16px; }
.setting-label { display: block; margin-bottom: 6px; font-size: 14px; }
.avatar-upload {
  width: 60px; height: 60px; border-radius: 50%;
  background: var(--input); display: flex;
  align-items: center; justify-content: center;
  cursor: pointer; overflow: hidden; margin-bottom: 10px;
}
.avatar-upload img { width: 100%; height: 100%; object-fit: cover; }

.quick-reply { display: flex; gap: 6px; flex-wrap: wrap; padding: 0 12px 6px; }
.quick-item { background: var(--input); padding: 4px 8px; border-radius: 6px; font-size: 12px; cursor: pointer; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.file-input { display: none; }
</style>
</head>
<body>

<div id="app">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">å…¨èƒ½èŠå¤©</div>
      <div class="user-info">
        <img id="myAvatar" class="avatar" src="">
        <span id="myId">åŠ è½½ä¸­â€¦</span>
      </div>
    </div>
    <div class="nav">
      <div class="nav-item active" data-page="chat">ğŸ’¬ èŠå¤©</div>
      <div class="nav-item" data-page="call">ğŸ“ éŸ³è§†é¢‘</div>
      <div class="nav-item" data-page="files">ğŸ“ æ–‡ä»¶åº“</div>
      <div class="nav-item" data-page="settings">âš™ è®¾ç½®</div>
      <div class="nav-item" data-page="admin" id="adminItem" style="display:none;">ğŸ”§ ç®¡ç†</div>
    </div>
  </div>

  <div class="main">
    <div class="header">
      <div class="room-name">å…¬å…±ç¾¤èŠ</div>
      <button class="btn secondary" onclick="showRoomModal()">æˆ¿é—´å¯†ç </button>
    </div>
    <div class="announcement-bar" id="announceBar">å…¬å‘Šï¼šæœªè®¾ç½®å…¬å‘Š</div>

    <div class="page show" id="chatPage">
      <div class="chat-area" id="chatArea"></div>
      <div class="quick-reply" id="quickWrap"></div>
      <div class="input-bar">
        <div class="toolbar">
          <button class="btn secondary" onclick="toggleEmoji()">ğŸ˜Š è¡¨æƒ…</button>
          <button class="btn secondary" onclick="openAtList()">@ æåŠ</button>
          <button class="btn secondary" onclick="openSchedule()">â° å®šæ—¶</button>
          <button class="btn secondary" onclick="document.getElementById('fileInput').click()">ğŸ“ æ–‡ä»¶</button>
          <button class="btn secondary" onclick="speakInput()">ğŸ”Š æ’­æŠ¥</button>
        </div>
        <input id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯â€¦">
        <button class="btn" onclick="sendMsg()">å‘é€</button>
      </div>
      <div id="emojiPanel" class="emoji-panel" style="display: none;"></div>
    </div>

    <div class="page" id="callPage">
      <div class="tab-bar">
        <div class="tab active" data-call="video">è§†é¢‘é€šè¯</div>
        <div class="tab" data-call="audio">è¯­éŸ³é€šè¯</div>
      </div>
      <div class="video-container" id="videos"></div>
      <div style="padding:10px;display:flex;gap:10px;">
        <button class="btn" onclick="startCall(true)">å¼€å¯æ‘„åƒå¤´</button>
        <button class="btn" onclick="startScreenShare()">å±å¹•å…±äº«</button>
        <button class="btn secondary" onclick="hangup()">æŒ‚æ–­</button>
      </div>
    </div>

    <div class="page" id="filesPage">
      <div class="files-list" id="filesList"></div>
    </div>

    <div class="page" id="settingsPage">
      <div class="settings">
        <div class="setting-item">
          <label class="setting-label">å¤´åƒ</label>
          <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
            <img id="avatarPreview" src="">
          </div>
          <input type="file" id="avatarInput" accept="image/*" class="file-input">
        </div>
        <div class="setting-item">
          <label class="setting-label">ç”¨æˆ·å</label>
          <input class="input-control" id="setName">
        </div>
        <div class="setting-item">
          <label class="setting-label">ä¸»é¢˜</label>
          <select class="input-control" id="themeSelect">
            <option value="dark">æ·±è‰²</option>
            <option value="light">æµ…è‰²</option>
          </select>
        </div>
        <div class="setting-item">
          <label class="setting-label">èŠå¤©èƒŒæ™¯</label>
          <input type="file" id="bgInput" accept="image/*" class="file-input">
          <button class="btn secondary" style="margin-top:6px;" onclick="setChatBg()">è®¾ç½®èƒŒæ™¯</button>
        </div>
        <div class="setting-item">
          <label class="setting-label">æˆ¿é—´å¯†ç </label>
          <input class="input-control" id="roomPwd" placeholder="ç•™ç©ºåˆ™æ— å¯†ç ">
        </div>
        <div class="setting-item">
          <label class="setting-label">ç®¡ç†å‘˜å¯†ç </label>
          <input class="input-control" id="adminPwd" placeholder="è®¾ç½®åæˆä¸ºç®¡ç†å‘˜">
        </div>
        <button class="btn" style="margin-top:10px;" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>

    <div class="page" id="adminPage">
      <div class="settings">
        <div class="setting-item">
          <label class="setting-label">ç¾¤å…¬å‘Š</label>
          <input class="input-control" id="announceInput" placeholder="è¾“å…¥å…¬å‘Š">
          <button class="btn secondary" style="margin-top:6px;" onclick="setAnnounce()">å‘å¸ƒå…¬å‘Š</button>
        </div>
        <div class="setting-item">
          <label class="setting-label">å¿«æ·å›å¤</label>
          <input class="input-control" id="quickInput" placeholder="ç”¨ | åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå¥½çš„|æ”¶åˆ°|è°¢è°¢">
          <button class="btn secondary" style="margin-top:6px;" onclick="setQuick()">è®¾ç½®å¿«æ·çŸ­è¯­</button>
        </div>
        <div class="setting-item">
          <label class="setting-label">ç”¨æˆ·ç®¡ç†</label>
          <div id="userList" style="display:grid;gap:6px;"></div>
        </div>
        <div class="setting-item">
          <label class="setting-label">æ¸…ç©ºæœ¬åœ°å†å²</label>
          <button class="btn secondary" onclick="clearHistory()">æ¸…ç©ºèŠå¤©è®°å½•</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å¼¹çª— -->
<div class="modal" id="roomModal">
  <div class="modal-box">
    <div class="modal-title">æˆ¿é—´å¯†ç éªŒè¯</div>
    <div class="input-group">
      <label class="input-label">è¾“å…¥æˆ¿é—´å¯†ç </label>
      <input class="input-control" id="inputPwd" type="password">
    </div>
    <div class="modal-btns">
      <button class="btn" onclick="checkRoomPwd()">è¿›å…¥</button>
      <button class="btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<div class="modal" id="atModal">
  <div class="modal-box">
    <div class="modal-title">æåŠç”¨æˆ·</div>
    <div id="atList" style="display:grid;gap:6px;max-height:260px;overflow-y:auto;"></div>
    <div class="modal-btns">
      <button class="btn secondary" onclick="closeModal()">å…³é—­</button>
    </div>
  </div>
</div>

<div class="modal" id="scheduleModal">
  <div class="modal-box">
    <div class="modal-title">å®šæ—¶å‘é€æ¶ˆæ¯</div>
    <div class="input-group">
      <label class="input-label">æ¶ˆæ¯å†…å®¹</label>
      <input class="input-control" id="scheduleText">
    </div>
    <div class="input-group">
      <label class="input-label">å»¶è¿Ÿç§’æ•°</label>
      <input class="input-control" id="scheduleSec" type="number" value="10">
    </div>
    <div class="modal-btns">
      <button class="btn" onclick="setSchedule()">ç¡®è®¤å®šæ—¶</button>
      <button class="btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
const userId = Math.random().toString(36).slice(2,10);
let myName = localStorage.getItem('userName') || 'ç”¨æˆ·'+userId.slice(-4);
let myAvatar = localStorage.getItem('userAvatar') || '';
let roomPassword = localStorage.getItem('roomPwd') || '';
let adminPassword = localStorage.getItem('adminPwd') || '';
let currentTheme = localStorage.getItem('theme') || 'dark';
let chatBg = localStorage.getItem('chatBg') || '';
let announcement = localStorage.getItem('announcement') || 'å…¬å‘Šï¼šæœªè®¾ç½®å…¬å‘Š';
let quickList = localStorage.getItem('quickList')?.split('|') || ['å¥½çš„','æ”¶åˆ°','è°¢è°¢','æ²¡é—®é¢˜'];
let isAdmin = !!adminPassword;

let messageList = JSON.parse(localStorage.getItem('chatHistory') || '[]');
let pinnedMsg = localStorage.getItem('pinnedMsg') || '';
let onlineUsers = {};
let mutedUsers = JSON.parse(localStorage.getItem('mutedUsers') || '[]');
let files = {};
let localStream = null;
let screenStream = null;
let pcMap = {};

const iceConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

// è‡ªåŠ¨è¿æ¥åç«¯ï¼Œä½ ä¸ç”¨æ”¹ä»»ä½•å†…å®¹
let ws;
function initSignaling() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const host = window.location.host;
  ws = new WebSocket(protocol + '//' + host);

  ws.onopen = () => console.log('âœ… å·²è¿æ¥æœåŠ¡å™¨');
  ws.onmessage = (e) => {
    const d = JSON.parse(e.data);
    if (d.roomPwd && d.roomPwd !== roomPassword) return;
    if (d.type === 'user') onlineUsers[d.from] = { name:d.name, avatar:d.avatar };
    if (d.type === 'msg') handleMsg(d);
    if (d.type === 'recall') handleRecall(d);
    if (d.type === 'read') handleRead(d);
    if (d.type === 'file') handleFileInfo(d);
    if (d.type === 'mute') handleMute(d);
    if (d.type === 'announce') { announcement = d.content; localStorage.setItem('announcement',announcement); renderAnnounce(); }
    if (d.type === 'pin') { pinnedMsg = d.mid; localStorage.setItem('pinnedMsg',pinnedMsg); renderChat(); }
    if (d.type === 'offer') handleOffer(d);
    if (d.type === 'answer') handleAnswer(d);
    if (d.type === 'ice') handleIce(d);
  };
  setInterval(() => send({ type:'user' }), 2000);
}

function send(data) {
  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify({
      ...data,
      from: userId,
      name: myName,
      avatar: myAvatar,
      roomPwd: roomPassword
    }));
  }
}

window.onload = () => {
  initTheme(); initUser(); initNav(); initEmoji();
  initSignaling(); bindEvents();
  loadChatBg(); renderAnnounce(); renderQuick(); renderChat();
  onlineUsers[userId] = { name:myName, avatar:myAvatar };
  if(isAdmin) document.getElementById('adminItem').style.display = 'block';
};

// ä¸»é¢˜
function initTheme(){
  document.documentElement.className = currentTheme === 'light' ? 'theme-light' : '';
  document.getElementById('themeSelect').value = currentTheme;
}
function switchTheme(v){
  currentTheme = v;
  localStorage.setItem('theme',v);
  document.documentElement.className = v === 'light' ? 'theme-light' : '';
}

// ç”¨æˆ·ä¿¡æ¯
function initUser(){
  document.getElementById('myId').textContent = myName;
  document.getElementById('myAvatar').src = myAvatar;
  document.getElementById('avatarPreview').src = myAvatar;
  document.getElementById('setName').value = myName;
  document.getElementById('roomPwd').value = roomPassword;
  document.getElementById('adminPwd').value = adminPassword;
  document.getElementById('announceInput').value = announcement;
}
function uploadAvatar(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    myAvatar = r.result;
    localStorage.setItem('userAvatar',myAvatar);
    initUser();
  };
  r.readAsDataURL(f);
}

// èŠå¤©èƒŒæ™¯
function setChatBg(){
  const f = document.getElementById('bgInput').files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    chatBg = r.result;
    localStorage.setItem('chatBg',chatBg);
    loadChatBg();
  };
  r.readAsDataURL(f);
}
function loadChatBg(){
  const a = document.getElementById('chatArea');
  if(chatBg) a.style.backgroundImage = `url(${chatBg})`;
  else a.style.backgroundImage = 'none';
}

// å…¬å‘Š
function setAnnounce(){
  announcement = document.getElementById('announceInput').value || 'å…¬å‘Šï¼šæœªè®¾ç½®å…¬å‘Š';
  localStorage.setItem('announcement',announcement);
  renderAnnounce();
  send({type:'announce', content:announcement});
}
function renderAnnounce(){
  document.getElementById('announceBar').innerText = announcement;
}

// å¿«æ·å›å¤
function setQuick(){
  const v = document.getElementById('quickInput').value.trim();
  if(!v) return;
  quickList = v.split('|');
  localStorage.setItem('quickList', quickList.join('|'));
  renderQuick();
}
function renderQuick(){
  const w = document.getElementById('quickWrap');
  w.innerHTML = '';
  quickList.forEach(t => {
    const d = document.createElement('div');
    d.className = 'quick-item';
    d.textContent = t;
    d.onclick = () => { document.getElementById('msgInput').value = t; };
    w.appendChild(d);
  });
}

// å¯¼èˆª
function initNav(){
  const items = document.querySelectorAll('.nav-item');
  const pages = document.querySelectorAll('.page');
  items.forEach(i => {
    i.onclick = () => {
      items.forEach(x => x.classList.remove('active'));
      pages.forEach(x => x.classList.remove('show'));
      i.classList.add('active');
      document.getElementById(i.dataset.page+'Page').classList.add('show');
      if(i.dataset.page === 'admin') refreshAdminList();
    };
  });
  document.querySelectorAll('.tab').forEach(t => {
    t.onclick = () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
    };
  });
}

// è¡¨æƒ…
const emojis = ['ğŸ˜€','ğŸ˜','ğŸ˜‚','ğŸ¤£','ğŸ˜ƒ','ğŸ˜„','ğŸ˜…','ğŸ˜†','ğŸ˜‰','ğŸ˜Š','ğŸ˜‹','ğŸ˜','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ¥³','ğŸ˜œ','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤©','ğŸ¤”','ğŸ¤«','ğŸ˜´','ğŸ˜¤','ğŸ¤®','ğŸ¤¬','ğŸ˜³','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜µ','ğŸ˜‡','ğŸ˜ˆ','ğŸ‘»','ğŸ‘½','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’Œ','ğŸ’˜','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’š','ğŸ’™','ğŸ’›','ğŸ¤','ğŸ¤','ğŸ–¤','â¤ï¸','ğŸ’‹','ğŸ‘‹','ğŸ¤š','ğŸ–','âœ‹','ğŸ¤Œ','ğŸ¤','ğŸ‘','ğŸ‘','âœŒ','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘Œ','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ‘‡','â˜','ğŸ‘€','ğŸ‘¤','ğŸ‘¥','ğŸ‘¶','ğŸ‘§','ğŸ‘¦','ğŸ‘©','ğŸ‘¨','ğŸ‘µ','ğŸ‘´','ğŸ™‹','ğŸ™Œ','ğŸ™','ğŸ’ª','ğŸ¦µ','ğŸ¦¶','ğŸ‘‚','ğŸ‘ƒ','ğŸ§ ','ğŸ‘','ğŸ‘…','ğŸ‘„'];
function initEmoji(){
  const p = document.getElementById('emojiPanel');
  emojis.forEach(e => {
    const d = document.createElement('div');
    d.className = 'emoji';
    d.textContent = e;
    d.onclick = () => insertEmoji(e);
    p.appendChild(d);
  });
}
function toggleEmoji(){
  const p = document.getElementById('emojiPanel');
  p.style.display = p.style.display === 'none' ? 'grid' : 'none';
}
function insertEmoji(e){
  const i = document.getElementById('msgInput');
  i.value += e;
  i.focus();
}

// è¯­éŸ³æ’­æŠ¥
function speakInput(){
  const t = document.getElementById('msgInput').value.trim();
  if(!t) return;
  const u = new SpeechSynthesisUtterance();
  u.text = t;
  speechSynthesis.speak(u);
}

// å¼¹çª—
function closeModal(){
  document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
}
function showRoomModal(){
  document.getElementById('roomModal').classList.add('show');
}
function checkRoomPwd(){
  const v = document.getElementById('inputPwd').value;
  if(v === roomPassword || !roomPassword) closeModal();
  else alert('å¯†ç é”™è¯¯');
}
function openSchedule(){
  document.getElementById('scheduleModal').classList.add('show');
}
function openAtList(){
  const l = document.getElementById('atList');
  l.innerHTML = '';
  for(const u in onlineUsers){
    const i = document.createElement('div');
    i.className = 'nav-item';
    i.textContent = onlineUsers[u].name;
    i.onclick = () => {
      document.getElementById('msgInput').value += `@${onlineUsers[u].name} `;
      closeModal();
    };
    l.appendChild(i);
  }
  document.getElementById('atModal').classList.add('show');
}

// å®šæ—¶å‘é€
function setSchedule(){
  const t = document.getElementById('scheduleText').value.trim();
  const s = parseInt(document.getElementById('scheduleSec').value) || 10;
  if(!t) return;
  closeModal();
  setTimeout(() => {
    const mid = Date.now()+'';
    addMessage({mid, from:userId, name:myName, content:t, mine:true, read:true});
    send({type:'msg', mid, content:t});
  }, s*1000);
  alert('å·²è®¾ç½®å®šæ—¶å‘é€');
}

// æ¶ˆæ¯å‘é€ä¸æ¸²æŸ“
function sendMsg(){
  if(mutedUsers.includes(userId)) return alert('ä½ å·²è¢«ç¦è¨€');
  const t = document.getElementById('msgInput').value.trim();
  if(!t) return;
  const mid = Date.now()+'';
  addMessage({mid, from:userId, name:myName, content:t, mine:true, read:true});
  send({type:'msg', mid, content:t});
  document.getElementById('msgInput').value = '';
  document.getElementById('emojiPanel').style.display = 'none';
}
function addMessage(m){
  messageList.push(m);
  if(messageList.length > 300) messageList.shift();
  localStorage.setItem('chatHistory', JSON.stringify(messageList));
  renderChat();
}
function renderChat(){
  const a = document.getElementById('chatArea');
  a.innerHTML = '';
  if(pinnedMsg){
    const p = messageList.find(x => x.mid === pinnedMsg);
    if(p){
      const d = document.createElement('div');
      d.className = 'message '+(p.mine ? 'mine' : 'other');
      d.innerHTML = `<div class="pinned-label">ç½®é¡¶</div><div class="msg-content">${p.content.replace(/@([^\s]+)/g,'<span class="msg-at">@$1</span>')}</div>`;
      a.appendChild(d);
    }
  }
  messageList.forEach(m => {
    const d = document.createElement('div');
    d.className = 'message '+(m.mine ? 'mine' : 'other');
    d.dataset.mid = m.mid;
    if(!m.mine){
      const n = document.createElement('div');
      n.className = 'msg-name';
      n.textContent = m.name;
      d.appendChild(n);
    }
    const c = document.createElement('div');
    c.className = 'msg-content';
    c.innerHTML = m.content.replace(/@([^\s]+)/g,'<span class="msg-at">@$1</span>');
    d.appendChild(c);
    const r = document.createElement('div');
    r.className = 'msg-read';
    r.textContent = m.read ? 'å·²è¯»' : 'æœªè¯»';
    d.appendChild(r);
    const ac = document.createElement('div');
    ac.className = 'msg-actions';
    if(m.mine || isAdmin){
      const b1 = document.createElement('button');
      b1.className = 'msg-btn';
      b1.textContent = 'Ã—';
      b1.onclick = () => recallMessage(m.mid);
      ac.appendChild(b1);
      if(isAdmin){
        const b2 = document.createElement('button');
        b2.className = 'msg-btn';
        b2.textContent = 'é¡¶';
        b2.onclick = () => pinMessage(m.mid);
        ac.appendChild(b2);
      }
    }
    d.appendChild(ac);
    a.appendChild(d);
  });
  a.scrollTop = 1e9;
}
function pinMessage(mid){
  pinnedMsg = mid;
  localStorage.setItem('pinnedMsg', mid);
  send({type:'pin', mid});
  renderChat();
}

// æ¶ˆæ¯å¤„ç†
function handleMsg(d){
  if(mutedUsers.includes(d.from)) return;
  addMessage({
    mid:d.mid, from:d.from, name:d.name, content:d.content, mine:false, read:false
  });
  send({type:'read', mid:d.mid});
}
function recallMessage(mid){
  send({type:'recall', mid});
  messageList = messageList.filter(x => x.mid !== mid);
  localStorage.setItem('chatHistory', JSON.stringify(messageList));
  renderChat();
}
function handleRecall(d){
  messageList = messageList.filter(x => x.mid !== d.mid);
  localStorage.setItem('chatHistory', JSON.stringify(messageList));
  renderChat();
}
function handleRead(d){
  messageList.forEach(m => { if(m.mid === d.mid) m.read = true });
  renderChat();
}

// æ–‡ä»¶
function sendFiles(e){
  if(mutedUsers.includes(userId)) return alert('ä½ å·²è¢«ç¦è¨€');
  Array.from(e.target.files).forEach(f => {
    const r = new FileReader();
    const fid = Date.now()+'';
    r.onload = () => {
      files[fid] = { name:f.name, type:f.type, data:r.result, progress:100 };
      send({type:'file', fid, fname:f.name, ftype:f.type});
      refreshFiles();
    };
    r.readAsDataURL(f);
  });
}
function handleFileInfo(d){
  files[d.fid] = { name:d.fname, type:d.ftype, data:'', progress:0 };
  refreshFiles();
  setTimeout(() => {
    files[d.fid].progress = 100;
    refreshFiles();
  },600);
}
function refreshFiles(){
  const l = document.getElementById('filesList');
  l.innerHTML = '';
  for(const fid in files){
    const f = files[fid];
    const i = document.createElement('div');
    i.className = 'file-item';
    if(f.type.startsWith('image/') && f.data){
      const img = document.createElement('img');
      img.className = 'file-preview';
      img.src = f.data;
      i.appendChild(img);
    }
    const n = document.createElement('div');
    n.className = 'file-name';
    n.textContent = f.name;
    i.appendChild(n);
    const p = document.createElement('div');
    p.className = 'file-progress';
    p.style.width = f.progress+'%';
    i.appendChild(p);
    const b = document.createElement('button');
    b.className = 'down-btn';
    b.textContent = f.progress >= 100 ? 'ä¸‹è½½' : 'æ¥æ”¶ä¸­â€¦';
    b.disabled = f.progress < 100;
    b.onclick = () => {
      const a = document.createElement('a');
      a.href = f.data;
      a.download = f.name;
      a.click();
    };
    i.appendChild(b);
    l.appendChild(i);
  }
}

// éŸ³è§†é¢‘
async function startCall(video){
  localStream = await navigator.mediaDevices.getUserMedia({audio:true, video});
  addVideo(userId, myName, localStream);
  broadcastCall();
}
async function startScreenShare(){
  screenStream = await navigator.mediaDevices.getDisplayMedia({audio:true, video:true});
  addVideo(userId, myName+'ï¼ˆå±å¹•ï¼‰', screenStream);
  broadcastCall();
}
function addVideo(uid, name, stream){
  const b = document.createElement('div');
  b.className = 'video-box';
  const v = document.createElement('video');
  v.autoplay = true;
  v.playsInline = true;
  v.srcObject = stream;
  const n = document.createElement('div');
  n.className = 'video-name';
  n.textContent = name;
  b.appendChild(v);
  b.appendChild(n);
  document.getElementById('videos').appendChild(b);
}
function hangup(){
  if(localStream) localStream.getTracks().forEach(t => t.stop());
  if(screenStream) screenStream.getTracks().forEach(t => t.stop());
  localStream = screenStream = null;
  pcMap = {};
  document.getElementById('videos').innerHTML = '';
}
async function broadcastCall(){
  for(const uid in onlineUsers){
    if(uid !== userId) await makeOffer(uid);
  }
}
async function makeOffer(peerId){
  const pc = new RTCPeerConnection(iceConfig);
  pcMap[peerId] = pc;
  if(localStream) localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  if(screenStream) screenStream.getTracks().forEach(t => pc.addTrack(t, screenStream));
  pc.onicecandidate = e => e.candidate && send({type:'ice', to:peerId, data:e.candidate});
  pc.ontrack = e => addVideo(peerId, onlineUsers[peerId]?.name || peerId, e.streams[0]);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  send({type:'offer', to:peerId, data:offer});
}
async function handleOffer(d){
  const pc = new RTCPeerConnection(iceConfig);
  pcMap[d.from] = pc;
  if(localStream) localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  if(screenStream) screenStream.getTracks().forEach(t => pc.addTrack(t, screenStream));
  pc.onicecandidate = e => e.candidate && send({type:'ice', to:d.from, data:e.candidate});
  pc.ontrack = e => addVideo(d.from, d.name, e.streams[0]);
  await pc.setRemoteDescription(d.data);
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  send({type:'answer', to:d.from, data:ans});
}
async function handleAnswer(d){
  await pcMap[d.from].setRemoteDescription(d.data);
}
async function handleIce(d){
  await pcMap[d.from].addIceCandidate(new RTCIceCandidate(d.data));
}

// ç®¡ç†å‘˜
function refreshAdminList(){
  const l = document.getElementById('userList');
  l.innerHTML = '';
  for(const uid in onlineUsers){
    const i = document.createElement('div');
    i.className = 'nav-item';
    i.style.display = 'flex';
    i.style.justifyContent = 'space-between';
    i.innerHTML = `
      <span>${onlineUsers[uid].name}</span>
      <button class="btn secondary" style="padding:2px 6px;font-size:12px;" onclick="toggleMute('${uid}')">
        ${mutedUsers.includes(uid) ? 'è§£ç¦' : 'ç¦è¨€'}
      </button>
    `;
    l.appendChild(i);
  }
}
function toggleMute(uid){
  mutedUsers.includes(uid)
    ? mutedUsers = mutedUsers.filter(x => x !== uid)
    : mutedUsers.push(uid);
  localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
  send({type:'mute', list:mutedUsers});
  refreshAdminList();
}
function handleMute(d){
  if(!isAdmin) return;
  mutedUsers = d.list;
  localStorage.setItem('mutedUsers', JSON.stringify(mutedUsers));
  refreshAdminList();
}
function clearHistory(){
  messageList = [];
  localStorage.removeItem('chatHistory');
  renderChat();
  alert('å·²æ¸…ç©ºæœ¬åœ°å†å²');
}

// è®¾ç½®ä¿å­˜
function saveSettings(){
  myName = document.getElementById('setName').value.trim() || myName;
  roomPassword = document.getElementById('roomPwd').value;
  adminPassword = document.getElementById('adminPwd').value;
  isAdmin = !!adminPassword;
  localStorage.setItem('userName', myName);
  localStorage.setItem('roomPwd', roomPassword);
  localStorage.setItem('adminPwd', adminPassword);
  switchTheme(document.getElementById('themeSelect').value);
  initUser();
  document.getElementById('adminItem').style.display = isAdmin ? 'block' : 'none';
  alert('ä¿å­˜æˆåŠŸ');
}

// äº‹ä»¶ç»‘å®š
function bindEvents(){
  document.getElementById('msgInput').addEventListener('keydown', e => {
    if(e.key === 'Enter') sendMsg();
  });
  document.getElementById('avatarInput').addEventListener('change', uploadAvatar);
  document.getElementById('fileInput').addEventListener('change', sendFiles);
}
</script>
</body>
</html>
